#!/bin/bash
# CloudShell script to create an S3 bucket for Patch Manager, rough, but should be able to follow

# --- VARIABLES (edit as needed) ---
AWS_REGION="us-east-1"
ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
BUCKET_NAME="your-bucketname-us-east-1"
EC2_ROLE_NAME="your-ssm-ec2-role"    # Replace with your EC2 SSM IAM role name

echo "Creating S3 bucket: $BUCKET_NAME in region $AWS_REGION..."

# 1. Create bucket
aws s3api create-bucket \
  --bucket $BUCKET_NAME \
  --region $AWS_REGION

# 2. Attach bucket policy
cat > bucket-policy.json <<EOL
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowSSMServiceAccess",
      "Effect": "Allow",
      "Principal": {
        "Service": "ssm.amazonaws.com"
      },
      "Action": [
        "s3:GetObject",
        "s3:PutObject"
      ],
      "Resource": "arn:aws:s3:::$BUCKET_NAME/*"
    },
    {
      "Sid": "AllowEC2InstanceRoleAccess",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::$ACCOUNT_ID:role/$EC2_ROLE_NAME"
      },
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::$BUCKET_NAME",
        "arn:aws:s3:::$BUCKET_NAME/*"
      ]
    }
  ]
}
EOL

aws s3api put-bucket-policy --bucket $BUCKET_NAME --policy file://bucket-policy.json
echo "Applied bucket policy."

# 3. Attach IAM policy to EC2 Role
cat > ec2-s3-policy.json <<EOL
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::$BUCKET_NAME",
        "arn:aws:s3:::$BUCKET_NAME/*"
      ]
    }
  ]
}
EOL

aws iam put-role-policy \
  --role-name $EC2_ROLE_NAME \
  --policy-name PatchManagerS3Access \
  --policy-document file://ec2-s3-policy.json

echo "Attached inline policy to $EC2_ROLE_NAME"

# 4. Enable bucket encryption & versioning (recommended best practice)
aws s3api put-bucket-encryption \
  --bucket $BUCKET_NAME \
  --server-side-encryption-configuration '{
    "Rules": [
      {
        "ApplyServerSideEncryptionByDefault": {
          "SSEAlgorithm": "AES256"
        }
      }
    ]
  }'

aws s3api put-bucket-versioning \
  --bucket $BUCKET_NAME \
  --versioning-configuration Status=Enabled

echo "Enabled encryption and versioning."

echo "S3 bucket $BUCKET_NAME is ready for Patch Manager."
